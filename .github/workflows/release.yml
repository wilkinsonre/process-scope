name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  release:
    name: Build, Sign & Release
    runs-on: macos-15
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Import Developer ID certificate
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          CERTIFICATE_PATH="$RUNNER_TEMP/developer_id.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          echo -n "$DEVELOPER_ID_CERT_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Install Apple WWDR and Developer ID intermediate certificates
          curl -sL https://www.apple.com/certificateauthority/DeveloperIDG2CA.cer -o "$RUNNER_TEMP/DeveloperIDG2CA.cer"
          curl -sL https://www.apple.com/certificateauthority/AppleWWDRCAG3.cer -o "$RUNNER_TEMP/AppleWWDRCAG3.cer"
          security import "$RUNNER_TEMP/DeveloperIDG2CA.cer" -k "$KEYCHAIN_PATH" -A
          security import "$RUNNER_TEMP/AppleWWDRCAG3.cer" -k "$KEYCHAIN_PATH" -A

          security import "$CERTIFICATE_PATH" \
            -P "$DEVELOPER_ID_CERT_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain-db

          # Verify identity is available
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Build Release
        run: |
          xcodebuild -project ProcessScope.xcodeproj \
            -scheme ProcessScope \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="${{ secrets.CODESIGN_IDENTITY }}" \
            build

      - name: Create DMG
        env:
          CODESIGN_IDENTITY: ${{ secrets.CODESIGN_IDENTITY }}
        run: |
          ./Scripts/create-dmg.sh --skip-build
          echo "DMG_SHA256=$(shasum -a 256 ProcessScope.dmg | awk '{print $1}')" >> "$GITHUB_ENV"
          echo "DMG_SIZE=$(stat -f%z ProcessScope.dmg)" >> "$GITHUB_ENV"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
        run: ./Scripts/notarize.sh

      - name: Recalculate SHA-256 after stapling
        run: |
          echo "DMG_SHA256=$(shasum -a 256 ProcessScope.dmg | awk '{print $1}')" >> "$GITHUB_ENV"

      - name: Update Sparkle appcast
        env:
          SPARKLE_EDDSA_KEY: ${{ secrets.SPARKLE_EDDSA_KEY }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ./Scripts/update-appcast.sh \
            "ProcessScope.dmg" \
            "$VERSION" \
            "https://github.com/wilkinsonre/process-scope/releases/download/v${VERSION}/ProcessScope.dmg"

      - name: Update Homebrew cask
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" HomebrewFormula/processcope.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${DMG_SHA256}\"/" HomebrewFormula/processcope.rb

      - name: Commit appcast and cask updates
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main
          git add docs/appcast.xml HomebrewFormula/processcope.rb
          git commit -m "chore: update appcast and cask for v${VERSION}" || true
          git push origin main

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          gh release create "v${VERSION}" \
            ProcessScope.dmg \
            --title "ProcessScope v${VERSION}" \
            --generate-notes \
            --notes-start-tag "$(git tag --sort=-version:refname | head -2 | tail -1)" \
            --verify-tag

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" 2>/dev/null || true
